name: Deploy to Production

on:
  push:
    branches:
      - main

jobs:
  deploy:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v3

      - name: Setup PHP
        uses: shivammathur/setup-php@v2
        with:
          php-version: '8.2'
          extensions: mbstring, xml, ctype, iconv, intl, pdo_sqlite, dom, filter, gd, json, mbstring, pdo, pdo_mysql
          coverage: none

      - name: Install Composer dependencies
        run: composer install --optimize-autoloader --no-dev --prefer-dist

      - name: Setup Node.js
        uses: actions/setup-node@v3
        with:
          node-version: '18'

      - name: Install NPM dependencies
        run: npm ci

      - name: Build frontend assets
        run: npm run build

      - name: Install sshpass
        run: sudo apt-get install -y sshpass

      - name: Deploy to server via rsync
        run: |
          sshpass -p 'Timbuktu123@@@' rsync -avz --delete \
            --exclude='.git' \
            --exclude='.git/' \
            --exclude='node_modules' \
            --exclude='node_modules/' \
            --exclude='tests' \
            --exclude='tests/' \
            --exclude='storage/logs/' \
            --exclude='.env' \
            --exclude='.env.*' \
            --exclude='.github' \
            --exclude='.github/' \
            --exclude='*.sqlite' \
            --exclude='database.sqlite' \
            --exclude='.gitignore' \
            --exclude='.editorconfig' \
            --exclude='phpunit.xml' \
            --exclude='README-GITHUB.md' \
            --exclude='.github-secrets-setup.txt' \
            -e "ssh -o StrictHostKeyChecking=no" \
            ./ g0mbqxoz5uaj@208.109.173.77:public_html/portal/

      - name: Run post-deployment commands
        run: |
          sshpass -p 'Timbuktu123@@@' ssh -o StrictHostKeyChecking=no g0mbqxoz5uaj@208.109.173.77 << 'EOF'
            cd public_html/portal
            php artisan config:cache
            php artisan route:cache
            php artisan view:cache
          EOF

      - name: Setup Laravel Scheduler (Cron)
        run: |
          sshpass -p 'Timbuktu123@@@' ssh -o StrictHostKeyChecking=no g0mbqxoz5uaj@208.109.173.77 << 'EOF'
            # Remove any existing Laravel scheduler entries
            crontab -l 2>/dev/null | grep -v "public_html/portal" | crontab -

            # Add new Laravel scheduler entry
            (crontab -l 2>/dev/null; echo "* * * * * cd /home/g0mbqxoz5uaj/public_html/portal && /usr/bin/php artisan schedule:run >> /dev/null 2>&1") | crontab -

            echo "Laravel Scheduler configured successfully!"
          EOF

      - name: Setup SSL Certificate (Let's Encrypt)
        run: |
          sshpass -p 'Timbuktu123@@@' ssh -o StrictHostKeyChecking=no g0mbqxoz5uaj@208.109.173.77 << 'EOF'
            # Check if certbot is installed
            if ! command -v certbot &> /dev/null; then
                echo "Certbot not found. Please install certbot first."
                echo "Installation instructions will be provided in output."
                exit 0
            fi

            # Note: SSL certificate generation requires domain name
            # This is a placeholder - actual certificate generation needs to be done manually
            echo "SSL Certificate Setup:"
            echo "To generate SSL certificate, run manually on server:"
            echo "sudo certbot --apache -d yourdomain.com -d www.yourdomain.com"
            echo "Or for webroot:"
            echo "sudo certbot certonly --webroot -w /home/g0mbqxoz5uaj/public_html/portal/public -d yourdomain.com"
          EOF

